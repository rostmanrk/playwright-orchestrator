# Playwright Orchestrator

A CLI tool for orchestrating and managing Playwright test execution.

Looking for smarter test sharding without complex configuration or external cloud services? If you have a database, Playwright Orchestrator is the right choice for you.

![Timeline](https://github.com/rostmanrk/playwright-orchestrator/raw/main/assets/timeline.png)

## üéØ Overview

Test are ordered base on test timeout
The project provides tooling to analyze and orchestrate Playwright tests using available storage plugin options. Currently available plugin options:

- file: Basic storage that uses a local file as storage.
- dynamo-db: Amazon's DynamoDB wrapper.
- pg: PostgreSQL wrapper.

## üì¶ Installation

Make sure Playwright is installed.

```bash
npm install @playwright-orchestrator/core --save-dev

npm install @playwright-orchestrator/<storage_plugin_name> --save-dev
```

## üöÄ Usage

Run the CLI tool:

```bash
npx playwright-orchestrator <command> <storage_type> [options]
```

## üìù Example

1. Run the `init` command. Required to run once to set up storage. Make sure that executing credentials have all permissions.

```bash
npx playwright-orchestrator init pg --connection-string "postgres://username:password@localhost:5432/postgres"
```

2. Run the `create` command. Required to run once per run.

```bash
npx playwright-orchestrator create pg --connection-string "postgres://username:password@localhost:5432/postgres" --workers 2
> 019464f7-1488-75d1-b5c0-5e7d3dde9195
```

3. Start the desired count of shards using the `run` command. Run ID is generated in the previous step. All Playwright options are already saved in the previous step.

```bash
npx playwright-orchestrator run pg --connection-string "postgres://username:password@localhost:5432/postgres" --run-id 019464f7-1488-75d1-b5c0-5e7d3dde9195
```

4. Failed tests can be started again using step 3.

5. Merge report using [Playwright's Merge-reports CLI](https://playwright.dev/docs/test-sharding#merge-reports-cli)

```bash
npx playwright merge-reports ./blob-reports --reporter html
```

## ‚öôÔ∏è Commands and Options

### `init`

Seeds data storage with necessary tables and initial configuration.
No additional options.

### `create`

Creates and configures a new test run. Outputs created run ID. Supports most of [playwright's options](https://playwright.dev/docs/test-cli#reference).

### `run`

Starts test shard for the provided test run.

Command generate blob reports into `--output` directory. To merge it use [Playwright's Merge-reports CLI](https://playwright.dev/docs/test-sharding#merge-reports-cli)

**`webServer` property is not supported and is ignored; make sure the app run beforehand.**

| Option         | Description                               | Type     | Default        | Required? |
| -------------- | ----------------------------------------- | -------- | -------------- | --------- |
| `--run-id`     | Run ID generated by `create` command      | `string` | -              | yes       |
| `-o, --output` | Directory for artifacts produced by tests | `string` | `blob_reports` | no        |

## ‚öôÔ∏è Subcommands and Options

Each command has corresponding subcommands for installed storages

### `file`

Use as a storage locally created file

| Option        | Description                      | Type     | Default   | Required? |
| ------------- | -------------------------------- | -------- | --------- | --------- |
| `--directory` | Directory to store test run data | `string` | test-runs | no        |

### `dynamo-db`

Use Amazon's DynamoDB as storage. Credentials are taken from AWS profile

| Option                | Description           | Type     | Default                   | Required? |
| --------------------- | --------------------- | -------- | ------------------------- | --------- |
| `--table-name-prefix` | Table(s) name prefix  | `string` | 'playwright-orchestrator' | no        |
| `--ttl`               | TTL in days           | `number` | 30                        | no        |
| `--endpoint-url`      | DynamoDB endpoint URL | `string` | -                         | no        |

### `pg`

Use PostgreSQL as storage.

| Option                | Description          | Type     | Default                   | Required? |
| --------------------- | -------------------- | -------- | ------------------------- | --------- |
| `--connection-string` | Connection string    | `string` | -                         | yes       |
| `--table-name-prefix` | Table(s) name prefix | `string` | 'playwright-orchestrator' | no        |

## üíª Development

Make sure podman and compose is installed. They used for tests and local debugging.

```bash
npm run watch # Watch mode for development
npm test # Run tests
npm run test-update # Update test snapshots
npm run link-packages # Link packages for local development
```

## ‚öñÔ∏è License

Licensed under the Apache License 2.0. See LICENSE.md for details.

## üîÆ Future plans

- ‚úÖ ~~More~~ Tests
- ‚¨ú Better Logging
- ‚¨ú Better Error Handling
- ‚¨ú MySQL adapter
- ‚¨ú MS SQL adapter
- ‚¨ú Redis adapter
- ‚¨ú MongoDB adapter
- ‚¨ú GHA reporter
- ‚¨ú More examples
- ‚¨ú Test History statistics (test duration trends, count of test failures for past n days, etc.)
- ‚¨ú Even more adapters (by request)
- ‚¨ú Create Documentation site.
- ‚¨ú Smarter test ordering based on previous execution duration

## ‚ö†Ô∏è Disclaimer

This library was created in a couple weeks of free time, so issues may occur, but I try to address them as quickly as I can. Don't hesitate to create an issue report or contribute.

## ü§ù Support

For now, the best way to support this project is to star it on GitHub and share it with your colleagues or the community.
