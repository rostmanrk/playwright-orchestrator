import { Option } from '@commander-js/extra-typings';
import { loadPlugins } from '../helpers/plugin.js';
import { generateReport, REPORTERS } from '../reporters/reporter-factory.js';
import { withErrorHandling } from './error-handler.js';
import { program } from './program.js';

export default async () => {
    const command = program.command('create-report').description('Create for selected storage type.');

    for await (const { factory, subCommand } of loadPlugins(command)) {
        subCommand
            .requiredOption('--run-id <string>', 'Run id generated by create command')
            .addOption(new Option('--reporter <string>', 'Reporter type').choices(REPORTERS).default('json'))
            .action(
                withErrorHandling(async (options) => {
                    const adapter = await factory(options);
                    await generateReport(await adapter.getReportData(options.runId), options.reporter);
                    await adapter.dispose();
                }),
            );
    }
};
