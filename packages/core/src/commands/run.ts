import { loadPlugins } from '../helpers/plugin.js';
import { TestRunner } from '../test-runner.js';
import { withErrorHandling } from './error-handler.js';
import { program } from './program.js';

export default async () => {
    const command = program.command('run').description('Start test run shard');

    for await (const { factory, subCommand } of loadPlugins(command)) {
        subCommand
            .requiredOption('--run-id <string>', 'Run id generated by create command')
            .option(
                '-o, --output <string>',
                'Output folder for blob reports. Existing content is deleted before writing the new report.',
                'blob-reports',
            )
            .action(
                withErrorHandling(async (options) => {
                    const adapter = await factory(options);
                    const runner = new TestRunner(options as any, adapter);
                    await runner.runTests();
                    console.log('Run completed');
                }),
            );
    }
};
